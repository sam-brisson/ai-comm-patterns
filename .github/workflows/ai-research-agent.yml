name: AI Content Research Agent

on:
  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      research_depth:
        description: 'Research depth (light/deep)'
        required: false
        default: 'light'
        type: choice
        options:
          - light
          - deep
      max_suggestions:
        description: 'Maximum article suggestions'
        required: false
        default: '3'
        type: string

env:
  SITE_URL: https://sam-brisson.github.io/ai-comm-patterns/
  BRANCH_PREFIX: agent-research
  
jobs:
  research-and-suggest:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '.github/scripts/requirements.txt'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt
          
      - name: Analyze existing site content
        id: analyze
        run: |
          python .github/scripts/analyze_site.py \
            --site-url "${{ env.SITE_URL }}" \
            --output-file site_analysis.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Research external sources
        id: research
        run: |
          python .github/scripts/research_sources.py \
            --depth "${{ github.event.inputs.research_depth || 'light' }}" \
            --output-file external_research.json
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          
      - name: Generate article suggestions
        id: generate
        run: |
          python .github/scripts/generate_suggestions.py \
            --site-analysis site_analysis.json \
            --research-data external_research.json \
            --max-suggestions "${{ github.event.inputs.max_suggestions || '3' }}" \
            --output-dir suggested_articles/
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          
      - name: Set Branch Name and Date
        id: branch_info
        run: |
          TIMESTAMP=$(date +'%Y%m%d')
          BRANCH_NAME="${{ env.BRANCH_PREFIX }}-${TIMESTAMP}-$(date +'%H%M')"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "date_slug=$TIMESTAMP" >> $GITHUB_OUTPUT
          
      - name: Commit suggested articles
        id: commit
        run: |
          DATE_SLUG="${{ steps.branch_info.outputs.date_slug }}"
          
          git checkout -b "${{ steps.branch_info.outputs.branch_name }}"
          
          mkdir -p "docs/suggested/${DATE_SLUG}"
          mkdir -p "docs/research/${DATE_SLUG}"
          
          if [ -d "suggested_articles/" ]; then
            mv suggested_articles/* "docs/suggested/${DATE_SLUG}/"
          fi
          
          mv site_analysis.json "docs/research/${DATE_SLUG}/"
          mv external_research.json "docs/research/${DATE_SLUG}/"
          
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/suggested/ docs/research/
          
          if git diff --staged --quiet; then
            echo "No new suggestions generated"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "🤖 AI Agent: Article suggestions for ${DATE_SLUG}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Push branch
        if: steps.commit.outputs.has_changes == 'true'
        run: |
          git push origin "${{ steps.branch_info.outputs.branch_name }}"

      - name: Authenticate gh CLI
        if: steps.commit.outputs.has_changes == 'true'
        run: echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          DATE_SLUG="${{ steps.branch_info.outputs.date_slug }}"
          PR_BODY=$(cat <<EOF
          ## AI Research Agent Report
          
          This PR contains new article suggestions generated by the AI research agent.
          
          ### What's Included
          - **Suggested Articles**: \`docs/suggested/${DATE_SLUG}/\`
          - **Research Data**: \`docs/research/${DATE_SLUG}/\`
          - **Methodology**: Analysis of existing content + external research
          
          ### Review Process
          1. 📖 Review suggested article outlines
          2. 🧪 Consider proposed collaboration experiments  
          3. ✏️ Edit/refine articles as needed
          4. 📝 Move approved articles to main docs/ directory
          5. 🔄 Merge when ready
          
          ### Research Scope
          - **Depth**: \`${{ github.event.inputs.research_depth || 'light' }}\`
          - **Max Suggestions**: \`${{ github.event.inputs.max_suggestions || '3' }}\`
          - **Site Analysis**: Latest content from ${{ env.SITE_URL }}
          
          Generated by [AI Content Research Agent](.github/workflows/ai-research-agent.yml) 🤖
          EOF
          )

          gh pr create \
            --base "main" \
            --head "${{ steps.branch_info.outputs.branch_name }}" \
            --title "🤖 AI Research Agent: Article Suggestions for ${DATE_SLUG}" \
            --body "$PR_BODY"
            
      - name: Post summary
        if: always()
        run: |
          if [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
            echo "✅ AI Research Agent completed successfully and created a new PR."
          else
            echo "ℹ️ AI Research Agent ran but found no new suggestions to create."
          fi
