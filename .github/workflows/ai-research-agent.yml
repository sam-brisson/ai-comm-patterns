name: AI Content Research Agent

on:
  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      research_depth:
        description: 'Research depth (light/deep)'
        required: false
        default: 'light'
        type: choice
        options:
          - light
          - deep
      max_suggestions:
        description: 'Maximum article suggestions'
        required: false
        default: '3'
        type: string

env:
  SITE_URL: https://sam-brisson.github.io/ai-comm-patterns/
  BRANCH_PREFIX: agent-research
  
jobs:
  research-and-suggest:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt
          
      - name: Analyze existing site content
        id: analyze
        run: |
          python .github/scripts/analyze_site.py \
            --site-url "${{ env.SITE_URL }}" \
            --output-file site_analysis.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Research external sources
        id: research
        run: |
          python .github/scripts/research_sources.py \
            --depth "${{ github.event.inputs.research_depth || 'light' }}" \
            --output-file external_research.json
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          
      - name: Generate article suggestions
        id: generate
        run: |
          python .github/scripts/generate_suggestions.py \
            --site-analysis site_analysis.json \
            --research-data external_research.json \
            --max-suggestions "${{ github.event.inputs.max_suggestions || '3' }}" \
            --output-dir suggested_articles/
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          
      - name: Create research branch
        id: branch
        run: |
          BRANCH_NAME="${{ env.BRANCH_PREFIX }}-$(date +%Y%m%d-%H%M)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"
          
      - name: Commit suggested articles
        run: |
          # Create directory structure
          mkdir -p docs/suggested/$(date +%Y%m%d)
          mkdir -p docs/research/$(date +%Y%m%d)
          
          # Move generated files
          if [ -d "suggested_articles/" ]; then
            mv suggested_articles/* docs/suggested/$(date +%Y%m%d)/
          fi
          
          # Move research data
          mv site_analysis.json docs/research/$(date +%Y%m%d)/
          mv external_research.json docs/research/$(date +%Y%m%d)/
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "AI Research Agent"
          
          # Commit changes
          git add docs/suggested/ docs/research/
          
          if git diff --staged --quiet; then
            echo "No new suggestions generated"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "🤖 AI Research Agent: New article suggestions for $(date +%Y-%m-%d)
            
            Generated by automated research agent:
            - Analyzed existing site content
            - Researched external sources  
            - Created article suggestions with experiments
            
            Review suggested articles in docs/suggested/$(date +%Y%m%d)/
            Research methodology in docs/research/$(date +%Y%m%d)/"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        id: commit
          
      - name: Push branch and create PR
        if: steps.commit.outputs.has_changes == 'true'
        run: |
          git push origin "${{ steps.branch.outputs.branch_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `🤖 AI Research Agent: Article Suggestions for ${date}`,
              head: '${{ steps.branch.outputs.branch_name }}',
              base: 'main',
              body: `## AI Research Agent Report
              
              This PR contains new article suggestions generated by the AI research agent.
              
              ### What's Included
              - **Suggested Articles**: \`docs/suggested/${date.replace(/-/g, '')}/\`
              - **Research Data**: \`docs/research/${date.replace(/-/g, '')}/\`
              - **Methodology**: Analysis of existing content + external research
              
              ### Review Process
              1. 📖 Review suggested article outlines
              2. 🧪 Consider proposed collaboration experiments  
              3. ✏️ Edit/refine articles as needed
              4. 📝 Move approved articles to main docs/ directory
              5. 🔄 Merge when ready
              
              ### Research Scope
              - **Depth**: \`${{ github.event.inputs.research_depth || 'light' }}\`
              - **Max Suggestions**: \`${{ github.event.inputs.max_suggestions || '3' }}\`
              - **Site Analysis**: Latest content from ${process.env.SITE_URL}
              
              Generated by [AI Content Research Agent](.github/workflows/ai-research-agent.yml) 🤖
              `
            });
            
            console.log(\`Created PR #\${pr.number}: \${pr.html_url}\`);
            
      - name: Post summary
        if: always()
        run: |
          if [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
            echo "✅ AI Research Agent completed successfully"
            echo "📝 Created PR with new article suggestions"
            echo "🔍 Research data saved for transparency"
          else
            echo "ℹ️ AI Research Agent ran but found no new suggestions"
            echo "📊 This might indicate the knowledge base is well-covered"
          fi